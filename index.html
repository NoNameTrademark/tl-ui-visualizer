<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TL UI Visualizer (Enhanced)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1320;
      --panel: #151a2b;
      --panel-2: #1b2238;
      --text: #e6e9ef;
      --muted: #9aa3b2;
      --accent: #4ECDC4;
      --danger: #ff6b6b;
      --warn: #f7b801;
      --unknown: #7a7f8c;
      --grid: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.12);
    }
    html, body {
      margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .app {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "header header"
        "sidebar main";
      height: 100%;
    }
    header {
      grid-area: header;
      padding: 12px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    }
    header h1 {
      font-size: 16px; margin: 0; font-weight: 600;
    }
    header .spacer { flex: 1; }
    .sidebar {
      grid-area: sidebar;
      background: var(--panel);
      padding: 12px;
      border-right: 1px solid var(--border);
      overflow: auto;
    }
    .main {
      grid-area: main;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 8px;
      padding: 8px;
      min-width: 0;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    .controls, .status, .legend {
      display: grid; gap: 8px;
    }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    label { color: var(--muted); font-size: 13px; }
    select, input[type="file"], button {
      background: var(--panel-2); color: var(--text);
      border: 1px solid var(--border); border-radius: 6px;
      font-size: 13px; padding: 6px 8px;
    }
    .canvas-wrap {
      position: relative; overflow: auto;
      background: repeating-conic-gradient(from 45deg, var(--panel) 0% 25%, var(--panel-2) 0% 50%) 0 0/24px 24px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    svg { background: transparent; display: block; }
    .comp-box {
      fill: none;
      stroke-width: 2;
    }
    .comp-label {
      font-size: 12px;
      paint-order: stroke;
      stroke: rgba(0,0,0,0.6);
      stroke-width: 3px;
      fill: #fff;
    }
    .tooltip {
      position: absolute; pointer-events: none; z-index: 20;
      background: #0b0f1a; border: 1px solid var(--border);
      color: var(--text); font-size: 12px; padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.35);
      display: none; max-width: 360px; line-height: 1.35;
    }
    .legend-item {
      display: flex; align-items: center; gap: 8px; font-size: 13px;
    }
    .legend-swatch {
      width: 14px; height: 14px; border-radius: 3px; border: 1px solid var(--border);
    }
    .warn { color: var(--warn); }
    .danger { color: var(--danger); }
    .muted { color: var(--muted); }
    .pill {
      font-size: 11px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border);
      background: var(--panel-2); color: var(--text);
    }
    .status-grid {
      display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 8px;
    }
    .status-item {
      background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 8px;
      display: grid; gap: 4px;
    }
    .status-item .label { font-size: 11px; color: var(--muted); }
    .status-item .value { font-size: 14px; font-weight: 600; }
    .footer-note { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Throne and Liberty UI Visualizer — Enhanced</h1>
      <span class="pill">Experimental</span>
      <div class="spacer"></div>
      <label for="lang">Language</label>
      <select id="lang" title="Language">
        <option value="en">English</option>
        <option value="ko">한국어</option>
        <option value="fr">Français</option>
      </select>
      <input type="file" id="file" accept=".json,.azj,application/json" />
      <button id="resetBtn" title="Clear loaded data">Reset</button>
    </header>

    <aside class="sidebar">
      <div class="card controls">
        <strong>Filters</strong>
        <label><input type="checkbox" id="showUnknown" checked /> Show unknown components</label>
        <label><input type="checkbox" id="showHidden" /> Show hidden/inactive components</label>
        <label><input type="checkbox" id="showVariants" checked /> Show variants overlay</label>
        <label><input type="checkbox" id="showLabels" checked /> Show labels</label>
      </div>

      <div class="card legend" id="legend">
        <strong>Legend</strong>
        <div id="legendItems" class="legend-items" style="display:grid; gap:6px;"></div>
      </div>

      <div class="card status">
        <strong>Status</strong>
        <div class="status-grid">
          <div class="status-item">
            <div class="label">Components</div>
            <div class="value" id="statComponents">0</div>
          </div>
          <div class="status-item">
            <div class="label">Unknown</div>
            <div class="value" id="statUnknown">0</div>
          </div>
          <div class="status-item">
            <div class="label">Hidden</div>
            <div class="value" id="statHidden">0</div>
          </div>
          <div class="status-item">
            <div class="label">Variants</div>
            <div class="value" id="statVariants">0</div>
          </div>
        </div>
        <div class="footer-note" id="statusNote">Load a .azj (JSON) file to start.</div>
      </div>
    </aside>

    <main class="main">
      <div class="card">
        <div class="row">
          <div>Canvas resolution: <span id="canvasInfo" class="muted">—</span></div>
          <div class="spacer"></div>
          <div>Game: <span id="gameInfo" class="muted">—</span></div>
          <div>System: <span id="systemInfo" class="muted">—</span></div>
          <div>UI scale: <span id="scaleInfo" class="muted">—</span></div>
        </div>
      </div>
      <div class="canvas-wrap" id="canvasWrap">
        <svg id="canvas" width="1920" height="1080" viewBox="0 0 1920 1080" role="img" aria-label="UI layout canvas"></svg>
        <div id="tooltip" class="tooltip" role="tooltip"></div>
      </div>
    </main>
  </div>

  <script type="module">
    import {
      loadDatabase,
      getDisplayName,
      getComponentMeta,
      getCategoryColor,
      isVariant,
      getBaseId,
      parseAzj,
      computeViewportTransform,
      coalesce,
    } from './utils.js';

    const els = {
      lang: document.getElementById('lang'),
      file: document.getElementById('file'),
      resetBtn: document.getElementById('resetBtn'),
      canvas: document.getElementById('canvas'),
      canvasWrap: document.getElementById('canvasWrap'),
      tooltip: document.getElementById('tooltip'),
      legendItems: document.getElementById('legendItems'),
      statusNote: document.getElementById('statusNote'),
      statComponents: document.getElementById('statComponents'),
      statUnknown: document.getElementById('statUnknown'),
      statHidden: document.getElementById('statHidden'),
      statVariants: document.getElementById('statVariants'),
      showUnknown: document.getElementById('showUnknown'),
      showHidden: document.getElementById('showHidden'),
      showVariants: document.getElementById('showVariants'),
      showLabels: document.getElementById('showLabels'),
      canvasInfo: document.getElementById('canvasInfo'),
      gameInfo: document.getElementById('gameInfo'),
      systemInfo: document.getElementById('systemInfo'),
      scaleInfo: document.getElementById('scaleInfo'),
    };

    const state = {
      db: null,
      azj: null,
      lang: localStorage.getItem('tlviz.lang') || 'en',
      filters: {
        showUnknown: true,
        showHidden: false,
        showVariants: true,
        showLabels: true,
      },
      transform: null,
      stats: { total: 0, unknown: 0, hidden: 0, variants: 0 },
    };

    function setLang(value) {
      state.lang = value;
      localStorage.setItem('tlviz.lang', value);
      renderAll();
    }

    function updateFilters() {
      state.filters.showUnknown = els.showUnknown.checked;
      state.filters.showHidden = els.showHidden.checked;
      state.filters.showVariants = els.showVariants.checked;
      state.filters.showLabels = els.showLabels.checked;
      renderAll();
    }

    function setStatusNote(text, type = '') {
      els.statusNote.textContent = text;
      els.statusNote.className = 'footer-note ' + (type || '');
    }

    function buildLegend() {
      const container = els.legendItems;
      container.innerHTML = '';
      const cats = state.db?.categories || {};
      for (const [name, spec] of Object.entries(cats)) {
        const item = document.createElement('div');
        item.className = 'legend-item';
        const sw = document.createElement('div');
        sw.className = 'legend-swatch';
        sw.style.background = spec.color || '#888';
        const label = document.createElement('div');
        label.textContent = name + (spec.description ? ` — ${spec.description}` : '');
        item.appendChild(sw);
        item.appendChild(label);
        container.appendChild(item);
      }
    }

    function clearCanvas() {
      const svg = els.canvas;
      while (svg.firstChild) svg.removeChild(svg.firstChild);
    }

    function setCanvasSize(w, h) {
      const svg = els.canvas;
      svg.setAttribute('width', String(w));
      svg.setAttribute('height', String(h));
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      els.canvasInfo.textContent = `${w}×${h}`;
    }

    function drawComponents() {
      clearCanvas();
      if (!state.azj || !state.transform) return;

      const { components } = state.azj;
      const { showUnknown, showHidden, showVariants, showLabels } = state.filters;
      const svg = els.canvas;
      const tooltip = els.tooltip;

      state.stats = { total: 0, unknown: 0, hidden: 0, variants: 0 };

      const toCanvasRect = (r) => {
        // r = {x,y,w,h} in game coords; apply transform
        const { scaleX, scaleY, offsetX, offsetY } = state.transform;
        return {
          x: Math.round(r.x * scaleX + offsetX),
          y: Math.round(r.y * scaleY + offsetY),
          w: Math.max(1, Math.round(r.w * scaleX)),
          h: Math.max(1, Math.round(r.h * scaleY)),
        };
      };

      const enterTooltip = (e, html) => {
        tooltip.innerHTML = html;
        tooltip.style.display = 'block';
        moveTooltip(e);
      };
      const leaveTooltip = () => {
        tooltip.style.display = 'none';
      };
      const moveTooltip = (e) => {
        const r = els.canvasWrap.getBoundingClientRect();
        const x = e.clientX - r.left + 12;
        const y = e.clientY - r.top + 12;
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
      };

      components.forEach(c => {
        const id = Number(c.id);
        const meta = getComponentMeta(state.db, id);
        const isVar = isVariant(state.db, id);
        const baseId = getBaseId(state.db, id);
        const isHidden = c.hidden === true || c.visible === false || c.enabled === false;

        state.stats.total += 1;
        if (!meta) state.stats.unknown += 1;
        if (isHidden) state.stats.hidden += 1;
        if (isVar) state.stats.variants += 1;

        if (isHidden && !showHidden) return;
        if (!meta && !showUnknown) return;

        const displayName = getDisplayName(state.db, id, state.lang);
        const category = meta?.category || 'Unknown';
        const color = getCategoryColor(state.db, category);

        const rect = toCanvasRect({
          x: Number(coalesce(c.x, c.left, c.posX, c.positionX, 0)),
          y: Number(coalesce(c.y, c.top, c.posY, c.positionY, 0)),
          w: Number(coalesce(c.w, c.width,  c.sizeX, c.sizeW, c.size, 120)),
          h: Number(coalesce(c.h, c.height, c.sizeY, c.sizeH, 48)),
        });

        // group
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('data-id', String(id));
        g.setAttribute('data-category', category);

        const box = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        box.setAttribute('x', String(rect.x));
        box.setAttribute('y', String(rect.y));
        box.setAttribute('width', String(rect.w));
        box.setAttribute('height', String(rect.h));
        box.setAttribute('class', 'comp-box');
        box.setAttribute('rx', '6');
        box.setAttribute('stroke', color);
        box.setAttribute('stroke-dasharray', (isVar && showVariants) ? '4 3' : '0');
        g.appendChild(box);

        if (state.filters.showLabels) {
          const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          label.setAttribute('x', String(rect.x + 6));
          label.setAttribute('y', String(rect.y + 16));
          label.setAttribute('class', 'comp-label');
          label.textContent = displayName;
          g.appendChild(label);
        }

        const tooltipHTML = `
          <div><strong>${displayName}</strong></div>
          <div class="muted">ID: ${id}${isVar ? ` (variant of ${baseId})` : ''}</div>
          <div>Category: ${category}</div>
          ${meta ? `
            <div class="muted">Translations: EN="${meta.name_en || '-'}" · KO="${meta.name_ko || '-'}" · FR="${meta.name_fr || '-'}"</div>
          ` : `<div class="warn">Unknown component — rendered with fallback</div>`}
        `;

        g.addEventListener('mouseenter', (e) => enterTooltip(e, tooltipHTML));
        g.addEventListener('mouseleave', leaveTooltip);
        g.addEventListener('mousemove', moveTooltip);

        svg.appendChild(g);
      });

      els.statComponents.textContent = String(state.stats.total);
      els.statUnknown.textContent = String(state.stats.unknown);
      els.statHidden.textContent = String(state.stats.hidden);
      els.statVariants.textContent = String(state.stats.variants);
    }

    function renderAll() {
      if (!state.db) return;
      buildLegend();
      if (state.azj && state.azj.meta) {
        const { system, game, viewportScale } = state.azj.meta;
        els.systemInfo.textContent = system ? `${system.w}×${system.h}` : '—';
        els.gameInfo.textContent = game ? `${game.w}×${game.h}` : '—';
        els.scaleInfo.textContent = viewportScale ? String(viewportScale) : '1.0';
      } else {
        els.systemInfo.textContent = '—';
        els.gameInfo.textContent = '—';
        els.scaleInfo.textContent = '—';
      }

      if (state.transform) {
        setCanvasSize(state.transform.canvasW, state.transform.canvasH);
      }
      drawComponents();
    }

    async function onFileSelected(file) {
      if (!file) return;
      setStatusNote('Validating file…');
      try {
        const text = await file.text();
        const parsed = parseAzj(text);
        state.azj = parsed;
        state.transform = computeViewportTransform(parsed.meta);
        setStatusNote('File loaded.', '');
      } catch (err) {
        console.error(err);
        setStatusNote('Failed to load file: ' + (err?.message || String(err)), 'danger');
        state.azj = null;
        state.transform = null;
      }
      renderAll();
    }

    function resetAll() {
      state.azj = null;
      state.transform = null;
      els.systemInfo.textContent = '—';
      els.gameInfo.textContent = '—';
      els.scaleInfo.textContent = '—';
      els.statComponents.textContent = '0';
      els.statUnknown.textContent = '0';
      els.statHidden.textContent = '0';
      els.statVariants.textContent = '0';
      setStatusNote('Reset. Load a .azj (JSON) file to start.', '');
      clearCanvas();
    }

    // Init
    (async function init() {
      els.lang.value = state.lang;
      els.lang.addEventListener('change', (e) => setLang(e.target.value));
      els.file.addEventListener('change', (e) => onFileSelected(e.target.files?.[0]));
      els.resetBtn.addEventListener('click', resetAll);
      els.showUnknown.addEventListener('change', updateFilters);
      els.showHidden.addEventListener('change', updateFilters);
      els.showVariants.addEventListener('change', updateFilters);
      els.showLabels.addEventListener('change', updateFilters);

      setStatusNote('Loading component database…');
      try {
        state.db = await loadDatabase('./components-database.json');
        buildLegend();
        setStatusNote('Ready. Load a .azj (JSON) file to start.');
      } catch (e) {
        console.error(e);
        setStatusNote('Failed to load component database. Unknown items will be shown in neutral color.', 'warn');
        state.db = { components: [], categories: { Unknown: { color: getComputedStyle(document.documentElement).getPropertyValue('--unknown').trim() } } };
      }
      renderAll();
    })();
  </script>
</body>
</html>