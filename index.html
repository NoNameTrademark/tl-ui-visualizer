<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Throne & Liberty UI Visualizer</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #202020;
      }

      #canvas {
        position: relative;
        background-color: #313131;
        overflow: hidden;
        width: 1920px;
        height: 1080px;
        transform-origin: center;
      }

      .inner {
        position: relative;
        margin: 0 25px;
        height: 100%;
        box-sizing: border-box;
      }

      .grid {
        position: absolute;
        top: 25px;
        left: 25px;
        right: 25px;
        bottom: 25px;
        z-index: 1;
        pointer-events: none;
        background-color: rgba(255, 255, 255, 0.2);
        border: 1px dashed #fff;
      }

      .item {
        position: absolute;
        border-radius: 5px;
        text-align: center;
        line-height: 50px;
        color: white;
        box-sizing: border-box;
        z-index: 0;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .item:hover {
        transform: scale(1.02);
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      }

      #name {
        text-shadow: 2px 2px 8px #000000;
      }

      .button {
        outline: none;
        border: 1px solid lightgreen;
        padding: 8px 12px;
        background-color: transparent;
        color: lightgreen;
        font-weight: bold;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
      }

      .button:hover {
        background-color: rgba(144, 238, 144, 0.1);
        transform: scale(1.05);
      }

      .button:active {
        background-color: rgba(144, 238, 144, 0.2);
        transform: scale(0.95);
      }

      kbd {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        padding: 2px 4px;
        font-size: 0.9em;
        font-family: monospace;
      }
    </style>
  </head>

  <body>
    <div id="canvas">
      <div class="inner"></div>
      <div class="grid"></div>
    </div>

    <script type="module">
      import * as utils from "./utils.js";

      let selectedFile;

      const ACTUAL_SCALE = utils.scales.TIER_5; // Default to TIER_5 (1.0 scale)

      let config = {
        systemResolution: { width: 1920, height: 1080 },
        gameResolution: { width: 2400, height: 1350 },
        viewportScale: ACTUAL_SCALE,
        canvasPadding: { left: 32, right: 32, top: 32, bottom: 32 },
        gridSize: { width: 32, height: 32 },
        usingGrid: true,
        usingAutoAlign: true,
        magneticThreshold: 4,
        adjacencyThreshold: 2,
        ApplicationScale: 2,
        ConsoleApplicationScale: 5,
      };

      function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          const randomIndex = Math.floor(Math.random() * 16);
          // Ensure the color is darker by limiting the range to 0-7
          color += letters[randomIndex % 8];
        }
        return color;
      }

      // Calculate scale factor and apply to the canvas
      function resizeCanvas() {
        const canvas = document.getElementById("canvas");
        const scale = Math.min(
          window.innerWidth / config.systemResolution.width,
          window.innerHeight / config.systemResolution.height
        );
        canvas.style.transform = `scale(${scale})`;
      }

      // Add event listener to handle window resize
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // Example of adding items on the canvas
      let addedButtons = new Set();

      const removeAllItems = () => {
        addedButtons.forEach((button) => button.remove());
        addedButtons.clear();
      };

      // Define a list to store hidden canvas elements
      let hiddenItems = new Set();

      function addItem(transform) {
        if (transform?.translate?.x === undefined) {
          console.log(`fudido: ${transform?.componentKey}`);
        }
        const { componentKey, desiredSize, align } = transform;
        const { width, height } = desiredSize;
        const { x, y } = transform.translate;

        const item = document.createElement("div");
        item.className = "item";

        // Position
        Object.entries(
          utils.getCorrectedAlignment(align, transform.translate)
        ).forEach(([key, val]) => {
          item.style[key] = val;
        });

        item.style.width = `${width}px`;
        item.style.height = `${height}px`;
        item.style.backgroundColor = getRandomColor();
        item.innerHTML = `<span>${utils.getNameById(componentKey)}</span>`;
        item.title = "Click to hide this UI element"; // Add tooltip
        item.style.fontSize = "0.7vw";
        item.querySelector("span").style.opacity = "0.4";
        item.dataset.key = componentKey;

        item.style.transform = `scale(${config.viewportScale})`;

        item.style.display = "flex";
        item.style.justifyContent = "center";
        item.style.alignItems = "center";

        // Hover effects
        item.addEventListener("mouseover", () => {
          item.querySelector("span").style.opacity = "1";
        });

        item.addEventListener("mouseout", () => {
          item.querySelector("span").style.opacity = "0.4";
        });

        // Click to hide
        item.addEventListener("click", () => {
          item.style.visibility = "hidden";
          hiddenItems.add(item);
        });

        document.querySelector(".inner").appendChild(item);
        addedButtons.add(item);
      }

      function showHiddenItems() {
        hiddenItems.forEach((item) => {
          item.style.visibility = "visible";
        });
      }

      // Show hidden items
      const showItems = document.createElement("button");
      showItems.innerText = "Show Hidden Items";
      showItems.style.position = "absolute";
      showItems.style.top = "150px";
      showItems.style.right = "50px";
      showItems.style.zIndex = "2";
      showItems.className = "button";

      showItems.addEventListener("click", showHiddenItems);

      document.getElementById("canvas").appendChild(showItems);

      // Toggle grid visibility
      const grid = document.querySelector(".grid");
      const toggleButton = document.createElement("button");
      toggleButton.innerText = "Toggle Grid";
      toggleButton.style.position = "absolute";
      toggleButton.style.top = "50px";
      toggleButton.style.right = "50px";
      toggleButton.style.zIndex = "2";
      toggleButton.className = "button";

      toggleButton.addEventListener("click", () => {
        grid.style.display = grid.style.display === "none" ? "block" : "none";
      });

      document.getElementById("canvas").appendChild(toggleButton);

      // Load items based on JSON
      const createScreen = (selectedViewportScale) => {
        fetch("./parser/test.json")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Failed to load test file: ${response.status} ${response.statusText}`);
            }
            return response.json();
          })
          .then((jsonData) => {
            // Validate JSON structure
            if (!jsonData.payload || !jsonData.payload.transforms || !jsonData.payload.reference) {
              throw new Error("Invalid test file structure. Missing required payload, transforms, or reference data.");
            }
            
            const { transforms, reference } = jsonData.payload;
            config = { ...reference };

            if (selectedViewportScale) {
              config = {
                ...reference,
                viewportScale: selectedViewportScale,
              };
            }

            transforms.forEach(addItem);
          })
          .catch((error) => {
            console.error("Error loading default file:", error);
            // Don't show alert for default file loading errors
          });
      };
      
      // Load default test file on initialization
      createScreen();

      const importButton = document.createElement("button");
      importButton.innerText = "Import T&L UI File (.azj)";
      importButton.style.position = "absolute";
      importButton.style.top = "100px";
      importButton.style.right = "50px";
      importButton.style.zIndex = "2";
      importButton.className = "button";

      importButton.addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".azj";
        input.style.display = "none";
        input.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file && file.name.endsWith(".azj")) {
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              alert("File is too large. Please select a file smaller than 5MB.");
              return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const jsonData = JSON.parse(e.target.result);
                
                // Validate JSON structure
                if (!jsonData.payload || !jsonData.payload.transforms || !jsonData.payload.reference) {
                  throw new Error("Invalid .azj file structure. Missing required payload, transforms, or reference data.");
                }
                
                // Check if transforms array is too large
                if (jsonData.payload.transforms.length > 500) {
                  if (!confirm(`This file contains ${jsonData.payload.transforms.length} UI elements. Loading may be slow. Continue?`)) {
                    return;
                  }
                }
                
                const { transforms, reference } = jsonData.payload;
                config = { ...reference };

                selectedFile = file.name;

                updateFileNameDisplay();

                removeAllItems();
                transforms.forEach(addItem);
              } catch (error) {
                console.error("Error parsing JSON:", error);
                alert(`Error loading file: ${error.message}`);
              }
            };
            reader.readAsText(file);
          } else {
            alert("Please upload a valid .azj file.");
          }
        });

        document.body.appendChild(input);
        input.click();
        document.body.removeChild(input);
      });

      document.getElementById("canvas").appendChild(importButton);

      const fileNameDisplay = document.createElement("div");
      fileNameDisplay.style.position = "absolute";
      fileNameDisplay.style.top = "10px";
      fileNameDisplay.style.left = "10px";
      fileNameDisplay.style.color = "white";
      fileNameDisplay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
      fileNameDisplay.style.padding = "5px 10px";
      fileNameDisplay.style.borderRadius = "5px";
      fileNameDisplay.style.zIndex = "2";
      fileNameDisplay.innerText = selectedFile
        ? `Loaded File: ${selectedFile}`
        : "Default test file loaded";

      document.getElementById("canvas").appendChild(fileNameDisplay);

      // Add help instructions
      const helpPanel = document.createElement("div");
      helpPanel.style.position = "absolute";
      helpPanel.style.bottom = "10px";
      helpPanel.style.left = "10px";
      helpPanel.style.color = "white";
      helpPanel.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
      helpPanel.style.padding = "10px";
      helpPanel.style.borderRadius = "5px";
      helpPanel.style.fontSize = "0.8em";
      helpPanel.style.zIndex = "2";
      helpPanel.style.maxWidth = "300px";
      helpPanel.innerHTML = `
        <strong>Controls:</strong><br>
        • Click UI elements to hide them<br>
        • Press <kbd>G</kbd> to toggle grid<br>
        • Press <kbd>H</kbd> to show hidden items<br>
        • Press <kbd>I</kbd> to import file<br>
        • Hover over elements for tooltips
      `;

      document.getElementById("canvas").appendChild(helpPanel);

      const updateFileNameDisplay = () => {
        fileNameDisplay.style.display = "block";
        fileNameDisplay.innerText = selectedFile
          ? `Loaded File: ${selectedFile}`
          : "Default test file loaded";
        
        // Only hide if a file was imported (not for default state)
        if (selectedFile) {
          setTimeout(() => {
            fileNameDisplay.style.display = "none";
          }, 3000);
        }
      };

      // Add keyboard shortcuts
      document.addEventListener("keydown", (event) => {
        // Press 'G' to toggle grid
        if (event.key.toLowerCase() === 'g' && !event.ctrlKey && !event.altKey) {
          event.preventDefault();
          grid.style.display = grid.style.display === "none" ? "block" : "none";
        }
        
        // Press 'H' to show hidden items
        if (event.key.toLowerCase() === 'h' && !event.ctrlKey && !event.altKey) {
          event.preventDefault();
          showHiddenItems();
        }
        
        // Press 'I' to import file
        if (event.key.toLowerCase() === 'i' && !event.ctrlKey && !event.altKey) {
          event.preventDefault();
          importButton.click();
        }
      });
    </script>
  </body>
</html>
